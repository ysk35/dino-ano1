# -*- coding: utf-8 -*-
"""anomalydino-demo.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1VJUVK2nHCkCDLAjrlzXaX_N9EQr2EyjA
"""

!git clone --branch feat/add-patch https://github.com/ysk35/dino-ano1.git

# Commented out IPython magic to ensure Python compatibility.
# %cd dino-ano1

# Commented out IPython magic to ensure Python compatibility.
# %ls

!pip install "numpy<2.0" faiss-cpu tifffile --no-cache

import faiss, numpy as np, tifffile
print(f"NumPy: {np.__version__}")     # 1.26.x
print(f"FAISS: {faiss.__version__}")  # 1.7.x or 1.8.x
print("âœ… å…¨ã¦æ­£å¸¸å‹•ä½œ")

from google.colab import drive
drive.mount('/content/drive')

# Commented out IPython magic to ensure Python compatibility.
# %cd dino-ano1

!cp "/content/drive/MyDrive/m2/data/mvtec_anomaly_detection.tar.xz" .

# Commented out IPython magic to ensure Python compatibility.
# %mkdir data

# Commented out IPython magic to ensure Python compatibility.
# %cd data
# %mkdir mvtec_anomaly_detection
# %cd ..

!tar -xf mvtec_anomaly_detection.tar.xz -C data/mvtec_anomaly_detection
!ls data/mvtec_anomaly_detection

!python run_anomalydino.py \
    --dataset MVTec \
    --data_root data/mvtec_anomaly_detection \
    --shots 1 \
    --num_seeds 3 \
    --stage1_threshold 0.16 \
    --stage2_threshold 0.12 \
    --preprocess informed \
    --faiss_on_cpu

!python analyze_fn.py results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed/detailed_scores_bottle_1shot.json \
  --stage1_threshold 0.16 \
  --stage2_threshold 0.12

!python visualize_scores.py results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed/detailed_scores_bottle_1shot.json \
 --output score_analysis.png

!python analyze_fn.py results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed/detailed_scores_cable_1shot.json

  # 2. capsuleã®FNåˆ†æï¼ˆSeedä¾å­˜æ€§ãŒå¤§ãã„ï¼‰
!python analyze_fn.py results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed/detailed_scores_capsule_1shot.json

  # 3. screwã®FNåˆ†æ
!python analyze_fn.py results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed/detailed_scores_screw_1shot.json

import json

with open('results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed/detailed_scores_cable_1shot.json') as f:
  data = json.load(f)
print('=== cable_swap ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¹ã‚³ã‚¢ ===')
for key, val in sorted(data.items()):
    if 'cable_swap' in key:
          print(f"{key}:")
          print(f"  patch: {val['patch_score']:.4f}, stats: {val['stats_score']:.4f}")
          print(f"  åˆ¤å®š: {val['is_anomaly']}, æ–¹æ³•: {val['detection_method']}")
          print(f"  gt_label: {val['gt_label']}")
          print()

import json
import numpy as np

# çµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
results_dir = "results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed"
num_seeds = 3

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
all_metrics = {}
for seed in range(num_seeds):
    try:
        with open(f"{results_dir}/metrics_seed={seed}.json") as f:
            all_metrics[seed] = json.load(f)
        print(f"âœ… Seed {seed}: èª­ã¿è¾¼ã¿æˆåŠŸ")
    except:
        print(f"âš ï¸  Seed {seed}: ãƒ•ã‚¡ã‚¤ãƒ«ãªã—")

if not all_metrics:
    print("âŒ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
else:
    # ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
    objects = list(all_metrics[0].keys())

    print("\n" + "="*80)
    print("{:<15} {:<22} {:<22}".format('Object', 'AUROC', 'F1'))
    print("="*80)

    all_auroc = []
    all_f1 = []

    for obj in sorted(objects):
        auroc_list = []
        f1_list = []

        for s in all_metrics.keys():
            if obj in all_metrics[s]:
                data = all_metrics[s][obj]
                # è¾æ›¸ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
                if isinstance(data, dict):
                    if 'classification_AUROC' in data:
                        auroc_list.append(data['classification_AUROC'])
                    if 'classification_F1' in data:
                        f1_list.append(data['classification_F1'])

        if auroc_list and f1_list:
            auroc_mean, auroc_std = np.mean(auroc_list), np.std(auroc_list)
            f1_mean, f1_std = np.mean(f1_list), np.std(f1_list)

            all_auroc.append(auroc_mean)
            all_f1.append(f1_mean)

            print("{:<15} {:.4f}Â±{:.4f}     {:.4f}Â±{:.4f}".format(obj, auroc_mean, auroc_std, f1_mean,
f1_std))
        else:
            print("{:<15} âš ï¸  ãƒ‡ãƒ¼ã‚¿ä¸æ­£".format(obj))

    print("="*80)
    if all_auroc and all_f1:
        print("{:<15} {:.4f}Â±{:.4f}     {:.4f}Â±{:.4f}".format('Average', np.mean(all_auroc),
np.std(all_auroc), np.mean(all_f1), np.std(all_f1)))
    print("="*80)

    # Seedä¾å­˜æ€§ãŒé«˜ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    print("\nğŸ” Seedä¾å­˜æ€§ãŒé«˜ã„ï¼ˆä¸å®‰å®šï¼‰Top 3:")
    variability = []
    for obj in objects:
        auroc_list = []
        for s in all_metrics.keys():
            if obj in all_metrics[s]:
                data = all_metrics[s][obj]
                if isinstance(data, dict) and 'classification_AUROC' in data:
                    auroc_list.append(data['classification_AUROC'])

        if len(auroc_list) >= 2:
            variability.append((obj, np.std(auroc_list), auroc_list))

    for obj, std, values in sorted(variability, key=lambda x: x[1], reverse=True)[:3]:
        seed_str = ", ".join(["S{}={:.3f}".format(i, v) for i, v in enumerate(values)])
        print("  {:<15} std={:.4f}  ({})".format(obj, std, seed_str))

import json

# å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§Stage2ã®è²¢çŒ®åº¦ã‚’ãƒã‚§ãƒƒã‚¯
objects = ['bottle', 'cable', 'capsule', 'carpet', 'grid', 'hazelnut',
            'leather', 'metal_nut', 'pill', 'screw', 'tile',
            'toothbrush', 'transistor', 'wood', 'zipper']

results_dir = "results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed"

print("="*80)
print("{:<15} {:<12} {:<12} {:<10}".format('Object', 'Stage1æ¤œçŸ¥', 'Stage2æ¤œçŸ¥', 'Stage2ç‡'))
print("="*80)

total_stage1 = 0
total_stage2 = 0

for obj in objects:
    try:
        with open("{}/detailed_scores_{}_1shot.json".format(results_dir, obj)) as f:
            data = json.load(f)

        stage1 = sum(1 for v in data.values() if v['detection_method'] == 'patch_based')
        stage2 = sum(1 for v in data.values() if v['detection_method'] == 'statistics_based')

        total_stage1 += stage1
        total_stage2 += stage2

        total = stage1 + stage2
        stage2_ratio = (stage2 / total * 100) if total > 0 else 0

        print("{:<15} {:<12} {:<12} {:>6.1f}%".format(obj, stage1, stage2, stage2_ratio))
    except:
        print("{:<15} ãƒ•ã‚¡ã‚¤ãƒ«ãªã—".format(obj))

print("="*80)
total = total_stage1 + total_stage2
if total > 0:
    print("{:<15} {:<12} {:<12} {:>6.1f}%".format('Total', total_stage1, total_stage2,
total_stage2/total*100))
else:
    print("{:<15} {:<12} {:<12} {}".format('Total', total_stage1, total_stage2, 'N/A'))
print("="*80)

if total_stage2 == 0:
    print("\nâš ï¸  Stage2ã§ã®æ¤œçŸ¥ãŒ0ä»¶ã§ã™ï¼")
    print("   â†’ Stage2ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŒã€å…¨ãæ©Ÿèƒ½ã—ã¦ã„ã¾ã›ã‚“")
    print("   â†’ stats_scoreãŒå…¨ã¦é–¾å€¤0.12ã‚’ä¸‹å›ã£ã¦ã„ã‚‹å¯èƒ½æ€§å¤§")
else:
    print("\nâœ… Stage2ãŒæ©Ÿèƒ½ã—ã¦ã„ã¾ã™ï¼ˆ{}ä»¶ / {}ä»¶ = {:.1f}%ï¼‰".format(total_stage2, total,
total_stage2/total*100))

import json

objects = ['bottle', 'cable', 'capsule', 'carpet', 'grid', 'hazelnut',
            'leather', 'metal_nut', 'pill', 'screw', 'tile',
            'toothbrush', 'transistor', 'wood', 'zipper']

results_dir = "results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed"

print("="*100)
print("{:<15} {:<10} {:<10} {:<12} {:<12} {:<10}".format(
    'Object', 'Stage1', 'Stage2-TP', 'Stage2-FP', 'Stage2åˆè¨ˆ', 'çœŸã®å¯„ä¸ç‡'))
print("="*100)

total_stage1 = 0
total_stage2_tp = 0  # True Positiveï¼ˆç•°å¸¸ã‚’æ­£ã—ãæ¤œçŸ¥ï¼‰
total_stage2_fp = 0  # False Positiveï¼ˆæ­£å¸¸ã‚’èª¤æ¤œçŸ¥ï¼‰

for obj in objects:
    try:
        with open("{}/detailed_scores_{}_1shot.json".format(results_dir, obj)) as f:
            data = json.load(f)

        stage1 = sum(1 for v in data.values() if v['detection_method'] == 'patch_based')

        # Stage2ã‚’æ­£ã—ãåˆ†é¡
        stage2_tp = sum(1 for v in data.values()
                        if v['detection_method'] == 'statistics_based'
                        and v['gt_label'] == True)  # ç•°å¸¸ã‚’æ­£ã—ãæ¤œçŸ¥

        stage2_fp = sum(1 for v in data.values()
                        if v['detection_method'] == 'statistics_based'
                        and v['gt_label'] == False)  # æ­£å¸¸ã‚’èª¤æ¤œçŸ¥

        total_stage1 += stage1
        total_stage2_tp += stage2_tp
        total_stage2_fp += stage2_fp

        stage2_total = stage2_tp + stage2_fp
        total_anomaly = sum(1 for v in data.values() if v['gt_label'] == True)
        contribution = (stage2_tp / total_anomaly * 100) if total_anomaly > 0 else 0

        print("{:<15} {:<10} {:<10} {:<12} {:<12} {:>6.1f}%".format(
            obj, stage1, stage2_tp, stage2_fp, stage2_total, contribution))
    except:
        print("{:<15} ãƒ•ã‚¡ã‚¤ãƒ«ãªã—".format(obj))

print("="*100)
total_anomaly_all = total_stage1 + total_stage2_tp
contribution_overall = (total_stage2_tp / total_anomaly_all * 100) if total_anomaly_all > 0 else 0

print("{:<15} {:<10} {:<10} {:<12} {:<12} {:>6.1f}%".format(
    'Total', total_stage1, total_stage2_tp, total_stage2_fp,
    total_stage2_tp + total_stage2_fp, contribution_overall))
print("="*100)

print("\nğŸ“Š ã‚µãƒãƒªãƒ¼:")
print("  Stage1ã§æ¤œçŸ¥ã—ãŸç•°å¸¸:     {}ä»¶".format(total_stage1))
print("  Stage2ã§æ•‘æ¸ˆã—ãŸç•°å¸¸(TP): {}ä»¶ â† çœŸã®å¯„ä¸".format(total_stage2_tp))
print("  Stage2ãŒèª¤æ¤œçŸ¥ã—ãŸ(FP):   {}ä»¶ â† ãƒã‚¤ãƒŠã‚¹åŠ¹æœ".format(total_stage2_fp))
print("  Stage2ã®çœŸã®å¯„ä¸ç‡:       {:.2f}%".format(contribution_overall))

if total_stage2_tp == 0:
    print("\nâš ï¸  Stage2ã¯ç•°å¸¸ã‚’1ä»¶ã‚‚æ•‘æ¸ˆã—ã¦ã„ã¾ã›ã‚“ï¼ˆå®Œå…¨ã«ç„¡æ©Ÿèƒ½ï¼‰")
elif total_stage2_fp > total_stage2_tp:
    print("\nâš ï¸  Stage2ã®FPãŒTPã‚ˆã‚Šå¤šã„ï¼ˆæ‚ªåŒ–ã•ã›ã¦ã„ã¾ã™ï¼‰")

# ==========================================
# FN/FPè©³ç´°åˆ†æï¼ˆColabã‚»ãƒ«ç”¨ï¼‰
# ==========================================

import json
import numpy as np

results_dir = "results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed"

objects = ['bottle', 'cable', 'capsule', 'carpet', 'grid', 'hazelnut',
            'leather', 'metal_nut', 'pill', 'screw', 'tile',
            'toothbrush', 'transistor', 'wood', 'zipper']

# é–¾å€¤ï¼ˆStage1ã®ã¿ä½¿ç”¨ï¼‰
threshold = 0.16

print("="*100)
print("ç¾çŠ¶ã®é–“é•ã„åˆ†æï¼ˆStage1ã®ã¿ã€é–¾å€¤=0.16ï¼‰")
print("="*100)

all_fn = []  # False Negative (è¦‹é€ƒã—)
all_fp = []  # False Positive (èª¤æ¤œçŸ¥)

for obj in objects:
    try:
        with open("{}/detailed_scores_{}_1shot.json".format(results_dir, obj)) as f:
            data = json.load(f)

        fn_samples = []
        fp_samples = []

        for key, val in data.items():
            patch_score = val['patch_score']
            gt_label = val['gt_label']

            # FN: ç•°å¸¸ã ãŒæ¤œçŸ¥ã§ããš (patch_score <= threshold)
            if gt_label == True and patch_score <= threshold:
                fn_samples.append((key, patch_score))
                all_fn.append((obj, key, patch_score))

            # FP: æ­£å¸¸ã ãŒèª¤æ¤œçŸ¥ (patch_score > threshold)
            elif gt_label == False and patch_score > threshold:
                fp_samples.append((key, patch_score))
                all_fp.append((obj, key, patch_score))

        if fn_samples or fp_samples:
            print("\nã€{}ã€‘".format(obj))
            if fn_samples:
                print("  FN (è¦‹é€ƒã—): {}ä»¶".format(len(fn_samples)))
                for key, score in sorted(fn_samples, key=lambda x: x[1])[:3]:
                    print("    - {}: score={:.4f}".format(key, score))
            if fp_samples:
                print("  FP (èª¤æ¤œçŸ¥): {}ä»¶".format(len(fp_samples)))
                for key, score in sorted(fp_samples, key=lambda x: x[1], reverse=True)[:3]:
                    print("    - {}: score={:.4f}".format(key, score))
    except:
        pass

# ã‚µãƒãƒªãƒ¼
print("\n" + "="*100)
print("ç·åˆã‚µãƒãƒªãƒ¼")
print("="*100)
print("ç·FN (è¦‹é€ƒã—):  {}ä»¶".format(len(all_fn)))
print("ç·FP (èª¤æ¤œçŸ¥):  {}ä»¶".format(len(all_fp)))
print("ç·ã‚¨ãƒ©ãƒ¼:       {}ä»¶".format(len(all_fn) + len(all_fp)))

# FNã‚’ç•°å¸¸ã‚¿ã‚¤ãƒ—åˆ¥ã«é›†è¨ˆ
print("\nã€FNï¼ˆè¦‹é€ƒã—ï¼‰ã‚’ç•°å¸¸ã‚¿ã‚¤ãƒ—åˆ¥ã«é›†è¨ˆã€‘")
fn_by_type = {}
for obj, key, score in all_fn:
    anomaly_type = key.split('/')[0]
    if anomaly_type not in fn_by_type:
        fn_by_type[anomaly_type] = []
    fn_by_type[anomaly_type].append((obj, key, score))

for anomaly_type, samples in sorted(fn_by_type.items(), key=lambda x: len(x[1]), reverse=True)[:10]:
    avg_score = np.mean([s[2] for s in samples])
    print("  {:<20} {}ä»¶ (å¹³å‡score={:.4f})".format(anomaly_type, len(samples), avg_score))

# FNã®ã‚¹ã‚³ã‚¢åˆ†å¸ƒ
if all_fn:
    fn_scores = [s[2] for s in all_fn]
    print("\nã€FNï¼ˆè¦‹é€ƒã—ï¼‰ã®ã‚¹ã‚³ã‚¢åˆ†å¸ƒã€‘")
    print("  å¹³å‡: {:.4f}".format(np.mean(fn_scores)))
    print("  ä¸­å¤®å€¤: {:.4f}".format(np.median(fn_scores)))
    print("  æœ€å¤§: {:.4f}".format(np.max(fn_scores)))
    print("  æœ€å°: {:.4f}".format(np.min(fn_scores)))
    print("  ç¾åœ¨ã®é–¾å€¤: 0.16")

# é–¾å€¤èª¿æ•´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
print("\n" + "="*100)
print("é–¾å€¤èª¿æ•´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")
print("="*100)
print("{:<10} {:<12} {:<12} {:<12} {:<12}".format("é–¾å€¤", "FNå‰Šæ¸›", "æ®‹ã‚ŠFN", "æ–°FPå¢—åŠ ", "ç·ã‚¨ãƒ©ãƒ¼"))
print("-"*60)

current_fn = len(all_fn)
current_fp = len(all_fp)

for new_threshold in [0.10, 0.12, 0.14, 0.16, 0.18, 0.20]:
    new_fn = 0
    new_fp = 0

    for obj in objects:
        try:
            with open("{}/detailed_scores_{}_1shot.json".format(results_dir, obj)) as f:
                data = json.load(f)

            for val in data.values():
                patch_score = val['patch_score']
                gt_label = val['gt_label']

                if gt_label == True and patch_score <= new_threshold:
                    new_fn += 1
                elif gt_label == False and patch_score > new_threshold:
                    new_fp += 1
        except:
            pass

    fn_reduction = current_fn - new_fn
    fp_increase = new_fp - current_fp
    total_error = new_fn + new_fp

    marker = " â† ç¾åœ¨" if new_threshold == 0.16 else ""
    print("{:<10.2f} {:<12} {:<12} {:<12} {:<12}{}".format(
        new_threshold, fn_reduction, new_fn, fp_increase, total_error, marker))

print("="*100)

# æœ€æ‚ªã®ã‚±ãƒ¼ã‚¹Top 10
print("\nã€æœ€ã‚‚è¦‹é€ƒã—ãŒå¤šã„ç•°å¸¸ã‚¿ã‚¤ãƒ— Top 10ã€‘")
for i, (anomaly_type, samples) in enumerate(sorted(fn_by_type.items(),
                                                      key=lambda x: len(x[1]),
                                                      reverse=True)[:10], 1):
    sample_list = ", ".join(["{}/{}".format(s[0], s[1].split('/')[1][:15]) for s in samples[:3]])
    print("{}. {:<20} {}ä»¶ - ä¾‹: {}".format(i, anomaly_type, len(samples), sample_list))

import json
import numpy as np

results_dir = "results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed"
problem_objects = ['cable', 'transistor', 'hazelnut', 'screw']

for obj in problem_objects:
    with open("{}/detailed_scores_{}_1shot.json".format(results_dir, obj)) as f:
        data = json.load(f)

    # æ­£å¸¸ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¹ã‚³ã‚¢
    normal_scores = [v['patch_score'] for v in data.values() if v['gt_label'] == False]

    print("\nã€{}ã€‘æ­£å¸¸ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¹ã‚³ã‚¢åˆ†å¸ƒ".format(obj))
    print("  å¹³å‡: {:.4f}".format(np.mean(normal_scores)))
    print("  ä¸­å¤®å€¤: {:.4f}".format(np.median(normal_scores)))
    print("  æœ€å¤§: {:.4f}".format(np.max(normal_scores)))
    print("  æœ€å°: {:.4f}".format(np.min(normal_scores)))
    print("  æ¨™æº–åå·®: {:.4f}".format(np.std(normal_scores)))
    print("  é–¾å€¤0.16è¶…: {}/{}ä»¶ ({:.1f}%)".format(
        sum(1 for s in normal_scores if s > 0.16),
        len(normal_scores),
        sum(1 for s in normal_scores if s > 0.16) / len(normal_scores) * 100
    ))

results_dir = "results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed"
problem_objects = ['cable', 'transistor', 'hazelnut', 'screw']

print("="*80)
print("{:<15} {:<12} {:<12} {:<12} {:<15}".format(
    "Object", "æ­£å¸¸å¹³å‡", "ç•°å¸¸å¹³å‡", "å·®åˆ†", "æœ€é©é–¾å€¤æ¨å®š"))
print("="*80)

for obj in problem_objects:
    with open("{}/detailed_scores_{}_1shot.json".format(results_dir, obj)) as f:
        data = json.load(f)

    normal_scores = [v['patch_score'] for v in data.values() if v['gt_label'] == False]
    anomaly_scores = [v['patch_score'] for v in data.values() if v['gt_label'] == True]

    normal_mean = np.mean(normal_scores)
    anomaly_mean = np.mean(anomaly_scores)
    diff = anomaly_mean - normal_mean

    # æœ€é©é–¾å€¤ã®æ¨å®šï¼ˆæ­£å¸¸ã®æœ€å¤§å€¤ã¨ç•°å¸¸ã®æœ€å°å€¤ã®ä¸­é–“ï¼‰
    normal_max = np.max(normal_scores)
    anomaly_min = np.min(anomaly_scores)

    if anomaly_min > normal_max:
        optimal_threshold = (normal_max + anomaly_min) / 2
        separable = "âœ… åˆ†é›¢å¯èƒ½"
    else:
        # é‡ãªã‚ŠãŒã‚ã‚‹å ´åˆã€ROCæ›²ç·šã§æœ€é©åŒ–ãŒå¿…è¦
        optimal_threshold = (normal_mean + anomaly_mean) / 2
        separable = "âŒ é‡ãªã‚Šã‚ã‚Š"

    print("{:<15} {:<12.4f} {:<12.4f} {:<12.4f} {:.4f} {}".format(
        obj, normal_mean, anomaly_mean, diff, optimal_threshold, separable))

    print("  æ­£å¸¸: æœ€å°={:.4f}, æœ€å¤§={:.4f}".format(np.min(normal_scores), np.max(normal_scores)))
    print("  ç•°å¸¸: æœ€å°={:.4f}, æœ€å¤§={:.4f}".format(np.min(anomaly_scores), np.max(anomaly_scores)))
    print()

print("="*80)

import json
import numpy as np

results_dir = "results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed"

optimal_thresholds = {
    'cable': 0.3968,
    'transistor': 0.3255,
    'hazelnut': 0.3922,
    'screw': 0.2207,
    'default': 0.16
}

objects = ['bottle', 'cable', 'capsule', 'carpet', 'grid', 'hazelnut',
            'leather', 'metal_nut', 'pill', 'screw', 'tile',
            'toothbrush', 'transistor', 'wood', 'zipper']

print("="*90)
print("{:<15} {:<15} {:<15} {:<15}".format(
    "Object", "F1 (ç¾åœ¨0.16)", "F1 (æœ€é©é–¾å€¤)", "æ”¹å–„"))
print("="*90)

f1_scores_current = []
f1_scores_optimal = []

for obj in objects:
    with open("{}/detailed_scores_{}_1shot.json".format(results_dir, obj)) as f:
        data = json.load(f)

    threshold_current = 0.16
    threshold_optimal = optimal_thresholds.get(obj, 0.16)

    # ç¾åœ¨ã®é–¾å€¤ã§ã®F1
    tp_c = sum(1 for v in data.values() if v['gt_label'] and v['patch_score'] > threshold_current)
    fp_c = sum(1 for v in data.values() if not v['gt_label'] and v['patch_score'] > threshold_current)
    fn_c = sum(1 for v in data.values() if v['gt_label'] and v['patch_score'] <= threshold_current)

    precision_c = tp_c / (tp_c + fp_c) if (tp_c + fp_c) > 0 else 0
    recall_c = tp_c / (tp_c + fn_c) if (tp_c + fn_c) > 0 else 0
    f1_c = 2 * precision_c * recall_c / (precision_c + recall_c) if (precision_c + recall_c) > 0 else 0

    # æœ€é©é–¾å€¤ã§ã®F1
    tp_o = sum(1 for v in data.values() if v['gt_label'] and v['patch_score'] > threshold_optimal)
    fp_o = sum(1 for v in data.values() if not v['gt_label'] and v['patch_score'] > threshold_optimal)
    fn_o = sum(1 for v in data.values() if v['gt_label'] and v['patch_score'] <= threshold_optimal)

    precision_o = tp_o / (tp_o + fp_o) if (tp_o + fp_o) > 0 else 0
    recall_o = tp_o / (tp_o + fn_o) if (tp_o + fn_o) > 0 else 0
    f1_o = 2 * precision_o * recall_o / (precision_o + recall_o) if (precision_o + recall_o) > 0 else 0

    f1_scores_current.append(f1_c)
    f1_scores_optimal.append(f1_o)

    diff = f1_o - f1_c
    marker = "âœ… +{:.4f}".format(diff) if diff > 0 else "âŒ {:.4f}".format(diff) if diff < 0 else "= 0.0000"

    print("{:<15} {:<15.4f} {:<15.4f} {}".format(obj, f1_c, f1_o, marker))

print("="*90)
avg_f1_current = np.mean(f1_scores_current)
avg_f1_optimal = np.mean(f1_scores_optimal)
improvement = avg_f1_optimal - avg_f1_current

print("{:<15} {:<15.4f} {:<15.4f} {:+.4f}".format(
    "å¹³å‡", avg_f1_current, avg_f1_optimal, improvement))
print("="*90)

if improvement > 0:
    print("\nâœ… ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆ¥æœ€é©é–¾å€¤ã§ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ï¼")
    print("   å¹³å‡F1ã‚¹ã‚³ã‚¢: {:.4f} â†’ {:.4f} ({:+.2%})".format(
        avg_f1_current, avg_f1_optimal, improvement/avg_f1_current))
else:
    print("\nâŒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆ¥æœ€é©é–¾å€¤ã§ã¯ç²¾åº¦ãŒä¸‹ãŒã‚Šã¾ã™")
    print("   å¹³å‡F1ã‚¹ã‚³ã‚¢: {:.4f} â†’ {:.4f} ({:+.2%})".format(
        avg_f1_current, avg_f1_optimal, improvement/avg_f1_current))

print("\nğŸ“Œ æ³¨æ„:")
print("   - AUROCã¯é–¾å€¤ã‚’å¤‰ãˆã¦ã‚‚å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚¹ã‚³ã‚¢åˆ†å¸ƒã¯åŒã˜ï¼‰")
print("   - F1ã‚¹ã‚³ã‚¢ã¯é–¾å€¤ã«ã‚ˆã£ã¦å¤‰ã‚ã‚Šã¾ã™")
print("   - ã“ã®çµæœã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆ¥é–¾å€¤ã®æœ‰åŠ¹æ€§ã‚’ç¤ºã—ã¾ã™")

# ==========================================
# è©³ç´°ãƒŸã‚¹åˆ†æ - æ”¹å–„æ–¹æ³•ç™ºè¦‹ã®ãŸã‚
# ==========================================

import json
import numpy as np
from collections import defaultdict

results_dir = "results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed"
threshold = 0.16

objects = ['bottle', 'cable', 'capsule', 'carpet', 'grid', 'hazelnut',
            'leather', 'metal_nut', 'pill', 'screw', 'tile',
            'toothbrush', 'transistor', 'wood', 'zipper']

# ãƒ‡ãƒ¼ã‚¿åé›†
all_data = {}
for obj in objects:
    try:
        with open("{}/detailed_scores_{}_1shot.json".format(results_dir, obj)) as f:
            all_data[obj] = json.load(f)
    except:
        pass

print("="*100)
print("è©³ç´°ãƒŸã‚¹åˆ†æãƒ¬ãƒãƒ¼ãƒˆ")
print("="*100)

# ========================================
# 1. ç•°å¸¸ã‚¿ã‚¤ãƒ—åˆ¥ã®å¤±æ•—åˆ†æ
# ========================================
print("\nã€1. ç•°å¸¸ã‚¿ã‚¤ãƒ—åˆ¥ã®å¤±æ•—ç‡ã€‘")
print("-"*100)

anomaly_type_analysis = defaultdict(lambda: {'total': 0, 'fn': 0, 'tp': 0})

for obj, data in all_data.items():
    for key, val in data.items():
        if val['gt_label']:  # ç•°å¸¸ã‚µãƒ³ãƒ—ãƒ«ã®ã¿
            anomaly_type = key.split('/')[0]
            anomaly_type_analysis[anomaly_type]['total'] += 1

            if val['patch_score'] <= threshold:
                anomaly_type_analysis[anomaly_type]['fn'] += 1
            else:
                anomaly_type_analysis[anomaly_type]['tp'] += 1

# å¤±æ•—ç‡ãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
sorted_types = sorted(anomaly_type_analysis.items(),
                      key=lambda x: x[1]['fn']/x[1]['total'] if x[1]['total'] > 0 else 0,
                      reverse=True)

print("{:<25} {:<10} {:<10} {:<15} {:<15}".format(
    "ç•°å¸¸ã‚¿ã‚¤ãƒ—", "ç·æ•°", "FN", "å¤±æ•—ç‡", "å¹³å‡ã‚¹ã‚³ã‚¢"))
print("-"*100)

for anomaly_type, stats in sorted_types[:20]:
    fn_rate = stats['fn'] / stats['total'] * 100 if stats['total'] > 0 else 0

    # å¹³å‡ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
    scores = []
    for obj, data in all_data.items():
        for key, val in data.items():
            if val['gt_label'] and key.split('/')[0] == anomaly_type:
                scores.append(val['patch_score'])

    avg_score = np.mean(scores) if scores else 0

    marker = "âš ï¸" if fn_rate > 50 else "âœ“"
    print("{:<25} {:<10} {:<10} {:<14.1f}% {:<15.4f} {}".format(
        anomaly_type, stats['total'], stats['fn'], fn_rate, avg_score, marker))

# ========================================
# 2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ã®å•é¡Œåˆ†æ
# ========================================
print("\n" + "="*100)
print("ã€2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ã®å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘")
print("-"*100)

for obj, data in all_data.items():
    normal_scores = [v['patch_score'] for v in data.values() if not v['gt_label']]
    anomaly_scores = [v['patch_score'] for v in data.values() if v['gt_label']]

    if not normal_scores or not anomaly_scores:
        continue

    normal_mean = np.mean(normal_scores)
    anomaly_mean = np.mean(anomaly_scores)
    separation = anomaly_mean - normal_mean

    fn_count = sum(1 for s in anomaly_scores if s <= threshold)
    fp_count = sum(1 for s in normal_scores if s > threshold)

    # å•é¡Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ¤å®š
    problem_pattern = []
    if separation < 0.1:
        problem_pattern.append("åˆ†é›¢ä¸è‰¯(å·®={:.3f})".format(separation))
    if normal_mean > 0.25:
        problem_pattern.append("æ­£å¸¸ãŒé«˜ã‚¹ã‚³ã‚¢(Î¼={:.3f})".format(normal_mean))
    if fp_count > len(normal_scores) * 0.5:
        problem_pattern.append("FPå¤šæ•°({}/{})".format(fp_count, len(normal_scores)))
    if fn_count > 0:
        problem_pattern.append("FNç™ºç”Ÿ({})".format(fn_count))

    if problem_pattern:
        print("\n{}: {}".format(obj, ", ".join(problem_pattern)))
        print("  æ­£å¸¸: Î¼={:.4f}, Ïƒ={:.4f}, range=[{:.4f}, {:.4f}]".format(
            normal_mean, np.std(normal_scores), np.min(normal_scores), np.max(normal_scores)))
        print("  ç•°å¸¸: Î¼={:.4f}, Ïƒ={:.4f}, range=[{:.4f}, {:.4f}]".format(
            anomaly_mean, np.std(anomaly_scores), np.min(anomaly_scores), np.max(anomaly_scores)))

# ========================================
# 3. ã‚¹ã‚³ã‚¢åˆ†å¸ƒã®å•é¡Œç‚¹
# ========================================
print("\n" + "="*100)
print("ã€3. ã‚¹ã‚³ã‚¢åˆ†å¸ƒã‹ã‚‰è¦‹ã‚‹æ ¹æœ¬å•é¡Œã€‘")
print("-"*100)

all_normal_scores = []
all_anomaly_scores = []

for obj, data in all_data.items():
    for val in data.values():
        if val['gt_label']:
            all_anomaly_scores.append(val['patch_score'])
        else:
            all_normal_scores.append(val['patch_score'])

print("\nå…¨ä½“çµ±è¨ˆ:")
print("  æ­£å¸¸ã‚µãƒ³ãƒ—ãƒ« (n={}):".format(len(all_normal_scores)))
print("    å¹³å‡={:.4f}, ä¸­å¤®å€¤={:.4f}, std={:.4f}".format(
    np.mean(all_normal_scores), np.median(all_normal_scores), np.std(all_normal_scores)))
print("    ç¯„å›²=[{:.4f}, {:.4f}]".format(np.min(all_normal_scores), np.max(all_normal_scores)))

print("\n  ç•°å¸¸ã‚µãƒ³ãƒ—ãƒ« (n={}):".format(len(all_anomaly_scores)))
print("    å¹³å‡={:.4f}, ä¸­å¤®å€¤={:.4f}, std={:.4f}".format(
    np.mean(all_anomaly_scores), np.median(all_anomaly_scores), np.std(all_anomaly_scores)))
print("    ç¯„å›²=[{:.4f}, {:.4f}]".format(np.min(all_anomaly_scores), np.max(all_anomaly_scores)))

print("\n  åˆ†é›¢åº¦: {:.4f} (ç†æƒ³: >0.2)".format(
    np.mean(all_anomaly_scores) - np.mean(all_normal_scores)))

# é‡ãªã‚Šç‡ã‚’è¨ˆç®—
overlap_min = max(np.min(all_anomaly_scores), np.min(all_normal_scores))
overlap_max = min(np.max(all_anomaly_scores), np.max(all_normal_scores))
overlap_ratio = (overlap_max - overlap_min) / (max(all_anomaly_scores) - min(all_normal_scores))
print("  é‡ãªã‚Šç‡: {:.1f}%".format(overlap_ratio * 100))

# ========================================
# 4. æ”¹å–„æ–¹å‘ã®ææ¡ˆ
# ========================================
print("\n" + "="*100)
print("ã€4. æ”¹å–„æ–¹å‘ã®ææ¡ˆã€‘")
print("="*100)

suggestions = []

# æ­£å¸¸ã®é«˜ã‚¹ã‚³ã‚¢å•é¡Œ
high_normal_objects = [obj for obj, data in all_data.items()
                        if np.mean([v['patch_score'] for v in data.values() if not v['gt_label']]) > 0.25]
if len(high_normal_objects) > 3:
    suggestions.append({
        'title': 'æ­£å¸¸ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¹ã‚³ã‚¢ãŒé«˜ã„ ({}/{} objects)'.format(len(high_normal_objects), len(objects)),
        'problem': '1-shotã®å‚ç…§ç”»åƒã§ã¯æ­£å¸¸ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚«ãƒãƒ¼ã§ããªã„',
        'solutions': [
            'â†’ k-shot (å‚ç…§ç”»åƒã‚’å¢—ã‚„ã™): 3-shot, 5-shotã§æ­£å¸¸ã®å¤šæ§˜æ€§ã‚’å­¦ç¿’',
            'â†’ æ­£å¸¸ç‰¹å¾´ã®å®‰å®šåŒ–: ãƒ¡ãƒ¢ãƒªãƒãƒ³ã‚¯ã®æ­£è¦åŒ–æ–¹æ³•ã‚’æ”¹å–„',
            'â†’ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ã®é©å¿œçš„é–¾å€¤å­¦ç¿’'
        ]
    })

# åˆ†é›¢ä¸è‰¯
if overlap_ratio > 0.5:
    suggestions.append({
        'title': 'æ­£å¸¸ã¨ç•°å¸¸ã®åˆ†é›¢ãŒä¸ååˆ† (é‡ãªã‚Šç‡{:.1f}%)'.format(overlap_ratio * 100),
        'problem': 'ãƒ‘ãƒƒãƒãƒ™ãƒ¼ã‚¹ç‰¹å¾´ã ã‘ã§ã¯è­˜åˆ¥å›°é›£',
        'solutions': [
            'â†’ ãƒãƒ«ãƒã‚¹ã‚±ãƒ¼ãƒ«ç‰¹å¾´: ç•°ãªã‚‹è§£åƒåº¦ã®ç‰¹å¾´ã‚’çµ„ã¿åˆã‚ã›',
            'â†’ ç©ºé–“çš„é–¢ä¿‚ã®åˆ©ç”¨: ãƒ‘ãƒƒãƒé–“ã®ç›¸å¯¾ä½ç½®æƒ…å ±ã‚’æ´»ç”¨',
            'â†’ ç•°å¸¸ã‚¿ã‚¤ãƒ—åˆ¥ã®ç‰¹å¾´é¸æŠ: ã‚¿ã‚¤ãƒ—ã”ã¨ã«æœ‰åŠ¹ãªç‰¹å¾´ã‚’å­¦ç¿’'
        ]
    })

# ç‰¹å®šç•°å¸¸ã‚¿ã‚¤ãƒ—ã®å¤±æ•—
high_failure_types = [t for t, s in sorted_types[:5]
                      if s['fn']/s['total'] > 0.3]
if high_failure_types:
    suggestions.append({
        'title': 'ç‰¹å®šã®ç•°å¸¸ã‚¿ã‚¤ãƒ—ã§é«˜å¤±æ•—ç‡',
        'problem': 'å¾®ç´°ãªç•°å¸¸ã‚„æ§‹é€ çš„ç•°å¸¸ã®æ¤œçŸ¥ãŒå›°é›£: {}'.format(', '.join(high_failure_types)),
        'solutions': [
            'â†’ ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«æ‰‹æ³•: è¤‡æ•°ã®ç‰¹å¾´æŠ½å‡ºå™¨ã‚’çµ„ã¿åˆã‚ã›',
            'â†’ æ³¨æ„æ©Ÿæ§‹: ç•°å¸¸é ˜åŸŸã«æ³¨ç›®ã™ã‚‹ä»•çµ„ã¿ã‚’å°å…¥',
            'â†’ äº‹å‰å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®å¤‰æ›´: DINOv2ä»¥å¤–ã‚‚è©¦ã™ (CLIP, MAEç­‰)'
        ]
    })

for i, sug in enumerate(suggestions, 1):
    print("\nææ¡ˆ{}. {}".format(i, sug['title']))
    print("  å•é¡Œ: {}".format(sug['problem']))
    print("  è§£æ±ºç­–:")
    for sol in sug['solutions']:
        print("    {}".format(sol))

print("\n" + "="*100)

import json
import numpy as np

results_dir = "results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed"

print("="*80)
print("FPã‚µãƒ³ãƒ—ãƒ«ã®ç‰¹å¾´åˆ†æ")
print("="*80)

problem_objects = ['cable', 'transistor']

for obj in problem_objects:
    with open("{}/detailed_scores_{}_1shot.json".format(results_dir, obj)) as f:
        data = json.load(f)

    # FPã‚µãƒ³ãƒ—ãƒ«ã®ã‚¹ã‚³ã‚¢
    fp_samples = [(k, v['patch_score']) for k, v in data.items()
                  if not v['gt_label'] and v['patch_score'] > 0.16]

    # æ­£å¸¸ã‚µãƒ³ãƒ—ãƒ«å…¨ä½“
    normal_scores = [v['patch_score'] for v in data.values() if not v['gt_label']]

    # ç•°å¸¸ã‚µãƒ³ãƒ—ãƒ«å…¨ä½“
    anomaly_scores = [v['patch_score'] for v in data.values() if v['gt_label']]

    print("\nã€{}ã€‘".format(obj))
    print("  FPã‚µãƒ³ãƒ—ãƒ«æ•°: {}".format(len(fp_samples)))
    print("  FPã‚¹ã‚³ã‚¢ç¯„å›²: [{:.4f}, {:.4f}]".format(
        min(s for _, s in fp_samples), max(s for _, s in fp_samples)))
    print("  æ­£å¸¸å…¨ä½“: Î¼={:.4f}, range=[{:.4f}, {:.4f}]".format(
        np.mean(normal_scores), min(normal_scores), max(normal_scores)))
    print("  ç•°å¸¸å…¨ä½“: Î¼={:.4f}, range=[{:.4f}, {:.4f}]".format(
        np.mean(anomaly_scores), min(anomaly_scores), max(anomaly_scores)))

    # FPã¯ç•°å¸¸ã«è¿‘ã„ã‹ï¼Ÿ
    fp_scores_only = [s for _, s in fp_samples]
    print("\n  FPã¯ç•°å¸¸ã‚¹ã‚³ã‚¢ã«è¿‘ã„ï¼Ÿ")
    print("    FPå¹³å‡={:.4f} vs ç•°å¸¸å¹³å‡={:.4f}".format(
        np.mean(fp_scores_only), np.mean(anomaly_scores)))
    print("    å·®åˆ†: {:.4f}".format(np.mean(anomaly_scores) - np.mean(fp_scores_only)))

    # åˆ¤å®š
    if np.mean(fp_scores_only) > np.mean(anomaly_scores) * 0.8:
        print("  â†’ FPã¯ç•°å¸¸ã«è¿‘ã„ã‚¹ã‚³ã‚¢ï¼ˆè¦‹ãŸç›®ãŒç•°å¸¸ã£ã½ã„å¯èƒ½æ€§ï¼‰")
        print("  â†’ ãƒãƒ«ãƒã‚¹ã‚±ãƒ¼ãƒ«ã§æ”¹å–„ã™ã‚‹å¯èƒ½æ€§: ä½")
    else:
        print("  â†’ FPã¯æ­£å¸¸ã¨ç•°å¸¸ã®ä¸­é–“ï¼ˆåˆ¤æ–­ãŒé›£ã—ã„ï¼‰")
        print("  â†’ ãƒãƒ«ãƒã‚¹ã‚±ãƒ¼ãƒ«ã§æ”¹å–„ã™ã‚‹å¯èƒ½æ€§: ä¸­")

print("\n" + "="*80)
print("\nã€çµè«–ã€‘")
print("  ã‚‚ã—FPãŒã€Œè¦‹ãŸç›®ãŒç•°å¸¸ã«è¿‘ã„ã€ãªã‚‰:")
print("    â†’ ãƒãƒ«ãƒã‚¹ã‚±ãƒ¼ãƒ«ã§ã¯æ”¹å–„ã—ãªã„")
print("    â†’ k-shotã§æ­£å¸¸ã®å¤šæ§˜æ€§ã‚’å¢—ã‚„ã™ã¹ã")
print("\n  ã‚‚ã—FPãŒã€Œä¸­é–“çš„ãªã‚¹ã‚³ã‚¢ã€ãªã‚‰:")
print("    â†’ ãƒãƒ«ãƒã‚¹ã‚±ãƒ¼ãƒ«ã§åˆ†é›¢ãŒæ”¹å–„ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š")
print("="*80)

# ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¹³å‡AUROCç¢ºèª
import json
with open('results_MVTec/dinov2_vits14_448/1-shot_preprocess=informed/metrics_seed=0.json', 'r') as f:
    metrics = json.load(f)
    auroc = metrics['mean_classification_au_roc'] * 100
    print(f"ğŸ¯ è«–æ–‡å†ç¾çµæœ - Mean AUROC: {auroc:.2f}%")
    print(f"ğŸ“Š è«–æ–‡å€¤: 96.6%")
    print(f"âœ… å·®ç•°: {auroc - 96.6:.1f}%")